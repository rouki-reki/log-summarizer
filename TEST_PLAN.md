# テスト計画書: Log Summarizer

## 1. テストの目的

本テスト計画は、「Log Summarizer」システムが `REQUIREMENTS.md` に定義された機能要件および非機能要件を満たしていることを確認することを目的とする。特に、ログの追加と階層的な要約生成ロジックが正しく動作することに重点を置く。

## 2. テスト範囲

以下の機能・コンポーネントをテスト対象とする。

*   **ログ追加機能**:
    *   API経由でのログエントリの受け付け
    *   ログノード（レベル0）のデータ構造の正当性
    *   ログデータの永続化
*   **階層的要約生成機能**:
    *   レベル1要約ノードの自動生成（5つのレベル0ノード蓄積時）
    *   レベルN要約ノードの自動生成（5つのレベルN-1ノード蓄積時、N > 1）
    *   要約生成トリガーロジックの正確性（ログ追加時のチェック）
    *   要約ノードのデータ構造（子ノード参照、タイムスタンプ範囲など）の正当性
    *   要約データの永続化
*   **データアクセス**:
    *   データベースへの基本的なCRUD操作（作成、読み取り）
*   **APIエンドポイント**:
    *   ログ追加用APIの動作確認
    *   （将来的に実装される場合）ログ取得APIの動作確認

**テスト範囲外**:
*   `REQUIREMENTS.md` の「5. 将来的な拡張」に記載されている機能（粒度調整取得アルゴリズムなど）
*   詳細なパフォーマンス測定
*   UIテスト（UIが存在しないため）

## 3. テストの種類

*   **単体テスト (Unit Tests)**:
    *   対象: 個別の関数、クラス、モジュール（例: 要約チェックロジック、データモデル、APIハンドラの一部）。
    *   目的: 各コンポーネントが独立して正しく動作することを確認する。
    *   ツール: Jest, Vitest などの JavaScript/TypeScript テストフレームワーク。
*   **結合テスト (Integration Tests)**:
    *   対象: 複数のコンポーネントを組み合わせた動作（例: APIエンドポイント呼び出し → サービスロジック → データ永続化 → 要約生成）。
    *   目的: コンポーネント間の連携が正しく行われることを確認する。
    *   ツール: Supertest (APIテスト用), テスト用データベース。
*   **E2Eテスト (End-to-End Tests)**:
    *   対象: システム全体を通したシナリオ。今回はAPIレベルでのシナリオテストが主となる。
    *   目的: 実際の利用ケースに近い形でシステム全体が期待通りに動作することを確認する。

## 4. テストケース（例）

| テストケースID | テスト対象機能        | テストシナリオ                                     | 期待される結果                                                                                                | テスト種類 |
| :------------- | :-------------------- | :------------------------------------------------- | :------------------------------------------------------------------------------------------------------------ | :--------- |
| TC-LOG-001     | ログ追加              | ログを1件追加する                                  | DBにレベル0ノードが1件保存される。要約ノードは生成されない。                                                    | 結合       |
| TC-LOG-002     | ログ追加              | ログを4件追加する                                  | DBにレベル0ノードが計4件保存される。要約ノードは生成されない。                                                    | 結合       |
| TC-SUM-001     | レベル1要約生成       | ログを5件追加する                                  | DBにレベル0ノードが計5件保存される。レベル1要約ノードが1件生成され、5つのログノードIDを`child_ids`に持つ。         | 結合       |
| TC-SUM-002     | レベル1要約生成       | ログを6件追加する                                  | DBにレベル0ノードが計6件保存される。レベル1要約ノードは1件のまま。未要約のレベル0ノードが1件存在する。             | 結合       |
| TC-SUM-003     | レベル1要約生成       | ログを10件追加する                                 | DBにレベル0ノードが計10件保存される。レベル1要約ノードが2件生成される（それぞれ子5件）。                           | 結合       |
| TC-SUM-004     | レベル2要約生成       | ログを24件追加する                                 | レベル1要約ノードが4件生成される。未要約のレベル0ノードが4件存在する。レベル2要約ノードは生成されない。             | 結合       |
| TC-SUM-005     | レベル2要約生成       | ログを25件追加する                                 | レベル1要約ノードが5件生成される。レベル2要約ノードが1件生成され、5つのレベル1要約ノードIDを`child_ids`に持つ。 | 結合       |
| TC-SUM-006     | レベル2要約生成       | ログを26件追加する                                 | レベル2要約ノードは1件のまま。未要約のレベル0ノードが1件存在する。                                             | 結合       |
| TC-SUM-007     | レベル3要約生成       | ログを125件追加する                                | レベル2要約ノードが5件生成される。レベル3要約ノードが1件生成され、5つのレベル2要約ノードIDを`child_ids`に持つ。 | 結合       |
| TC-API-001     | APIエンドポイント     | ログ追加APIに正しい形式でPOSTリクエストを送る        | ステータスコード201 (Created) または 200 (OK) が返却され、レスポンスボディに作成されたログ情報が含まれる。        | E2E        |
| TC-API-002     | APIエンドポイント     | ログ追加APIに不正な形式でPOSTリクエストを送る      | ステータスコード400 (Bad Request) が返却される。                                                              | E2E        |
| TC-UNIT-001    | 要約チェックロジック  | 未要約ノードが4つの状態でチェック関数を呼び出す    | 要約生成がトリガーされないことを確認する。                                                                    | 単体       |
| TC-UNIT-002    | 要約チェックロジック  | 未要約ノードが5つの状態でチェック関数を呼び出す    | 要約生成がトリガーされることを確認する。                                                                      | 単体       |

## 5. テスト環境

*   **開発環境**: 開発者のローカルマシン
*   **テスト環境**: CI/CDパイプライン上、または専用のテストサーバー
*   **データベース**: 開発・テスト用に分離されたデータベースインスタンス（例: SQLite, Docker上のPostgreSQL/MySQLなど）

## 6. テスト実施体制

*   開発者による単体テストおよび結合テストの実装・実施。
*   CI/CDパイプラインによる自動テストの実行。

## 7. 合格基準

*   計画された全ての単体テスト、結合テスト、E2Eテストケースが成功すること。
*   コードカバレッジが一定の基準（例: 80%以上）を満たすこと（努力目標）。