# テスト計画書: ログ取得機能 (粒度調整)

## 1. はじめに

### 1.1. 目的

本ドキュメントは、「Log Summarizer」システムの新しい機能である「粒度調整ログ取得」機能のテスト計画を定義する。この機能は、指定された件数 `k` のログを取得する際に、「最新の情報ほど細かい粒度（低レベルノード）で、古い情報ほど粗い粒度（高レベルノード）で」取得することを目指す。

### 1.2. アプローチ

テスト駆動開発 (TDD) のアプローチを採用する。まず、具体的なテストケースと、それに対する期待される出力（取得されるべきノードのリスト）を定義する。この定義に基づきテストコードを実装し、その後、テストをパスする機能コードを実装する。

## 2. 前提条件

*   既存のログ追加機能 (`POST /logs`) が正しく動作していること。
*   階層的な要約生成ロジックが `REQUIREMENTS.md` に従って正しく動作していること。
*   テスト実行前に、指定された数のログがシステムに追加され、対応する要約ノードが生成されている初期状態を準備できること。

## 3. 初期状態の定義

テストケースの実行前に、以下の2つの初期状態を準備する。ノードの ID や正確なタイムスタンプはテスト実行時に動的に決定されるが、各レベルのノード数と、どのノードがどの親に属するか（または属さないか）の構造は以下の通りとする。

### 3.1. ケース1: 100ログ入力後の状態

*   **入力**: 100件のログエントリを順に追加。
*   **生成されるノード**:
    *   Level 0 (LogNode): 100個
    *   Level 1 (SummaryNode): 100 / 5 = 20個
    *   Level 2 (SummaryNode): 20 / 5 = 4個
    *   Level 3 (SummaryNode): 4 / 5 = 0個 (生成されない)
*   **ノード間の関係**:
    *   100個の L0 ノードは、それぞれいずれかの L1 ノードを親として持つ (`parentId` が設定されている)。
    *   20個の L1 ノードは、それぞれいずれかの L2 ノードを親として持つ。
    *   4個の L2 ノードは、親を持たない (`parentId` が `null`)。これらが現時点での「未要約」の最高レベルノードとなる。
*   **未要約ノードリスト (parentId === null)**: L2ノード x 4個

### 3.2. ケース2: 1000ログ入力後の状態

*   **入力**: 1000件のログエントリを順に追加。
*   **生成されるノード**:
    *   Level 0 (LogNode): 1000個
    *   Level 1 (SummaryNode): 1000 / 5 = 200個
    *   Level 2 (SummaryNode): 200 / 5 = 40個
    *   Level 3 (SummaryNode): 40 / 5 = 8個
    *   Level 4 (SummaryNode): 8 / 5 = 1個 (余り L3 x 3)
*   **ノード間の関係**:
    *   1000個の L0 ノード -> L1 の子
    *   200個の L1 ノード -> L2 の子
    *   40個の L2 ノード -> L3 の子
    *   5個の L3 ノード -> L4 の子
    *   3個の L3 ノード -> 親なし (`parentId` が `null`)
    *   1個の L4 ノード -> 親なし (`parentId` が `null`)
*   **未要約ノードリスト (parentId === null)**: L3ノード x 3個, L4ノード x 1個

## 4. 期待される取得アルゴリズム（初期案）

取得件数 `k` を満たすために、以下のルールでノードを選択する。このルールは初期実装のためのものであり、将来的に改善される可能性がある。

1.  **未要約ノードの収集**: システム内に存在する全てのノードのうち、`parentId` が `null` であるノード（＝まだ上位の要約に含まれていないノード）を収集する。
2.  **ソート**: 収集した未要約ノードを、まず **レベルの低い順 (0, 1, 2, ...)**、次に同じレベル内では **タイムスタンプの新しい順** でソートする。
3.  **ノード選択**: ソートされたリストの先頭から順にノードを選択し、結果リストに追加していく。
4.  **件数制限**: 結果リストに追加されたノードの数が `k` に達したら、選択を終了する。
5.  **結果**: 選択されたノードのリストを返す。

**注意点**: このアルゴリズムは、「最新の情報を優先する」点は満たすが、「古い情報ほど粗い粒度で」という要件は完全には満たさない可能性がある（例えば、kが小さい場合、最新のL0ノードのみが返される）。また、返されるノードが表す元ログの合計件数が `k` と一致するとは限らない。これは初期段階のテストにおける許容範囲とする。

## 5. テストケース

APIエンドポイント `GET /logs/query?k=<number>` (仮) を想定してテストケースを定義する。

### 5.1. ケース1 (100ログ初期状態)

*   **初期状態**: 3.1 の状態 (未要約: L2 x 4)
*   **未要約ノード (新しい順)**: L2_4, L2_3, L2_2, L2_1 (仮ID)

| テストID     | 入力 (k) | 期待される出力 (ノードリスト、新しい順) | 理由                                                                 |
| :----------- | :------- | :-------------------------------------- | :------------------------------------------------------------------- |
| TC-GET-100-1 | 1        | [L2_4]                                  | 未要約ノードの中で最もレベルが低く新しいもの (この場合L2が最低)        |
| TC-GET-100-2 | 3        | [L2_4, L2_3, L2_2]                      | 未要約L2ノードを新しい順に3つ取得                                      |
| TC-GET-100-3 | 4        | [L2_4, L2_3, L2_2, L2_1]                | 未要約L2ノードをすべて取得                                             |
| TC-GET-100-4 | 5        | [L2_4, L2_3, L2_2, L2_1]                | k=5だが未要約ノードは4つしかないため、4つ返す (アルゴリズムの仕様) |

### 5.2. ケース2 (1000ログ初期状態)

*   **初期状態**: 3.2 の状態 (未要約: L3 x 3, L4 x 1)
*   **未要約ノード (レベル低→新順)**: L3_3, L3_2, L3_1, L4_1 (仮ID)

| テストID      | 入力 (k) | 期待される出力 (ノードリスト、レベル低→新順) | 理由                                                                 |
| :------------ | :------- | :----------------------------------------- | :------------------------------------------------------------------- |
| TC-GET-1000-1 | 1        | [L3_3]                                     | 未要約ノードの中で最もレベルが低く新しいL3ノード                     |
| TC-GET-1000-2 | 2        | [L3_3, L3_2]                               | 未要約L3ノードを新しい順に2つ取得                                      |
| TC-GET-1000-3 | 3        | [L3_3, L3_2, L3_1]                         | 未要約L3ノードをすべて取得                                             |
| TC-GET-1000-4 | 4        | [L3_3, L3_2, L3_1, L4_1]                   | 未要約L3をすべて取得し、次にレベルが高いL4を取得                       |
| TC-GET-1000-5 | 10       | [L3_3, L3_2, L3_1, L4_1]                   | k=10だが未要約ノードは4つしかないため、4つ返す (アルゴリズムの仕様) |

## 6. テスト実装方針

*   Jest と Supertest を使用して結合テストを実装する。
*   各テストケースの前に、`beforeEach` または `beforeAll` を使用して指定された数のログをAPI経由で追加し、初期状態をセットアップする。
*   テスト対象のAPIエンドポイント (`GET /logs/query?k=...`) を呼び出す。
*   返却されたノードリストの内容（含まれるノードのID、レベル、順序）が、上記で定義した期待値と一致することを確認する。
*   期待値のノードIDは動的に決定されるため、ID自体ではなく、返却されたノードのレベルと順序、および件数が期待通りであることを検証する。