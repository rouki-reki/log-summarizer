# 要件定義書: Log Summarizer

## 1. 概要

本ドキュメントは、ログデータを階層的に要約・管理するシステム「Log Summarizer」の要件を定義する。

## 2. 目的

*   大量のログデータを効率的に管理する。
*   ログデータを階層的に要約し、データの粒度を調整可能にする。
*   将来的には、最新のログほど詳細に、古いログほど概要的にアクセスできる仕組みの基盤を構築する。

## 3. 機能要件

### 3.1. ログの追加

*   システムは新しいログエントリを受け付け、保存できること。
*   各ログエントリは一意の識別子、内容、タイムスタンプを持つこと。これを「ログノード (Log Node)」または「レベル0ノード」と呼ぶ。

### 3.2. 階層的な要約の自動生成

*   **トリガー**: 新しいログノードが追加されるたびに、システムは要約生成のチェックを行うこと。
*   **チェックロジック**:
    1.  追加されたログノード（レベル0）と同じ親を持たない（＝まだどの要約ノードにも属していない）レベル0ノードの数をカウントする。
    2.  カウントが5に達した場合、それら5つのレベル0ノードを子とする「レベル1要約ノード」を生成する。
    3.  レベル1要約ノードが生成された場合、次に同じ親を持たないレベル1要約ノードの数をカウントする。
    4.  カウントが5に達した場合、それら5つのレベル1ノードを子とする「レベル2要約ノード」を生成する。
    5.  このプロセスを再帰的に、新しい要約ノードが生成されなくなるまで、またはチェック対象のレベルのノード数が5未満になるまで繰り返す。
*   **要約ノードの特性**:
    *   各要約ノードは、自身が要約する5つの子ノードへの参照（IDリスト）を持つこと。
    *   要約ノードの内容（Summary Content）は、初期段階では子ノードのIDリスト、タイムスタンプ範囲（最初の子ノードのタイムスタンプと最後の子ノードのタイムスタンプ）、レベル情報などを含むこと。具体的な要約アルゴリズムは将来的な課題とする。
    *   生成された要約ノードは、次のレベルの要約生成チェックの対象となる。

### 3.3. データ構造

*   ログおよび要約ログは、ノードとして管理されること。
*   各ノードは以下の情報を持つことが考えられる（RDBライクな構造を想定）:
    *   `id`: 一意な識別子 (Primary Key)
    *   `type`: ノードの種類 ('log' または 'summary')
    *   `level`: ノードの階層レベル (生ログは 0, レベル1要約は 1, ...)
    *   `content`: ログの内容、または要約の内容
    *   `timestamp`: ログの発生時刻、または要約の生成時刻
    *   `parent_id`: (オプション) 親ノードのID（要約ノードの場合、自身を生成するトリガーとなった5つのノードとは異なる概念。例えば、特定のコンテキストに属するなど。初期段階では不要かもしれない）
    *   `child_ids`: (要約ノードの場合) 要約対象となった5つの子ノードのIDリスト

### 3.4. 階層構造の図示

以下に、ログノード (L0) からレベル1要約ノード (S1)、レベル2要約ノード (S2) が生成される例を示す。

```
          S2_Node_A (Level 2)
         /    |    |    |    \
       /      |      |      |      \
     S1_A    S1_B    S1_C    S1_D    S1_E  (Level 1 Nodes)
    / | | | \ / | | | \ ... (each S1 summarizes 5 L0 nodes)
   /| | | \ /| | | \
 L0 L0 L0 L0 L0 L0 L0 L0 L0 L0 ... (Level 0 Log Nodes)

凡例:
- L0: ログノード (Log Node)
- S1: レベル1要約ノード (Summary Level 1 Node)
- S2: レベル2要約ノード (Summary Level 2 Node)

説明:
1. L0ノードが5つ蓄積されると、それらを子とするS1ノードが生成される (例: S1_A は最初の5つのL0を要約)。
2. S1ノードが5つ (S1_A から S1_E まで) 蓄積されると、それらを子とするS2ノード (S2_Node_A) が生成される。
3. この構造はさらに上位レベル (S3, S4, ...) へと拡張される。
```

### 3.5. 命名規則（案）

*   ログノード: `log_node_<id>`
*   レベル1要約ノード: `summary1_node_<id>`
*   レベル2要約ノード: `summary2_node_<id>`
*   (一般化): `summary<level>_node_<id>`

## 4. 非機能要件

*   **使用技術**: TypeScript を主要言語として使用すること。
*   **実行環境**: Node.js 環境で動作し、Webサーバー (HTTP API) として機能を提供できること。
*   **永続化**: ログおよび要約データは永続化されること（具体的なDBの種類は未定だが、RDBまたはそれに準ずる構造を想定）。

## 5. 将来的な拡張（今回のスコープ外）

*   **粒度調整取得**: 指定された件数 `k` のログを取得する際に、最新のログほど詳細なレベル（レベル0に近い）で、古いログほど粗いレベル（レベルが高い）のノードを組み合わせて取得するアルゴリズムを実装する。
    *   例: 20件取得する場合、最新のログノード12件、レベル1要約ノード3件（=15件分の元ログ）、レベル2要約ノード1件（=25件分の元ログ）などを組み合わせる（組み合わせの最適化アルゴリズムが必要）。

## 6. 用語定義

*   **ログノード (Log Node)**: システムに追加される個々のログエントリ。レベル0のノード。
*   **要約ノード (Summary Node)**: 5つの下位ノード（ログノードまたは下位の要約ノード）をまとめたノード。レベル1以上のノード。
*   **レベル (Level)**: ノードの階層を示す数値。生ログはレベル0。レベル(N-1)のノード5つから生成された要約ノードはレベルN。