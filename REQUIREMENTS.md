# 要件定義書: Log Summarizer

## 1. 概要

本ドキュメントは、ログデータを階層的に要約・管理するシステム「Log Summarizer」の要件を定義する。

## 2. 目的

*   大量のログデータを効率的に管理する。
*   ログデータを階層的に要約し、データの粒度を調整可能にする。
*   将来的には、最新のログほど詳細に、古いログほど概要的にアクセスできる仕組みの基盤を構築する。

## 3. 機能要件

### 3.1. ログの追加

*   システムは新しいログエントリを受け付け、保存できること。
*   各ログエントリは一意の識別子、内容、タイムスタンプを持つこと。これを「ログノード (Log Node)」または「レベル0ノード」と呼ぶ。

### 3.2. 階層的な要約の自動生成

*   **レベル1要約**: 同じ親を持たないログノードが5つ蓄積された時点で、それら5つのログノードを子とする「レベル1要約ノード (Summary Level 1 Node)」を自動生成すること。
    *   要約ノードは、自身が要約する5つの子ノードへの参照（またはIDリスト）を持つこと。
    *   要約ノードの内容（Summary Content）の生成方法は別途定義が必要だが、初期段階では子ノードのIDリストやタイムスタンプ範囲などを含む簡単な情報でよい。
*   **レベルN要約**: 同様に、レベル(N-1)の要約ノードが5つ蓄積された時点で、それら5つのレベル(N-1)要約ノードを子とする「レベルN要約ノード (Summary Level N Node)」を自動生成すること (N > 1)。
*   このプロセスは再帰的に適用されること。

### 3.3. データ構造

*   ログおよび要約ログは、ノードとして管理されること。
*   各ノードは以下の情報を持つことが考えられる（RDBライクな構造を想定）:
    *   `id`: 一意な識別子 (Primary Key)
    *   `type`: ノードの種類 ('log' または 'summary')
    *   `level`: ノードの階層レベル (生ログは 0, レベル1要約は 1, ...)
    *   `content`: ログの内容、または要約の内容
    *   `timestamp`: ログの発生時刻、または要約の生成時刻
    *   `parent_id`: (オプション) 親ノードのID（要約ノードの場合、自身を生成するトリガーとなった5つのノードとは異なる概念。例えば、特定のコンテキストに属するなど。初期段階では不要かもしれない）
    *   `child_ids`: (要約ノードの場合) 要約対象となった5つの子ノードのIDリスト

### 3.4. 命名規則（案）

*   ログノード: `log_node_<id>`
*   レベル1要約ノード: `summary1_node_<id>`
*   レベル2要約ノード: `summary2_node_<id>`
*   (一般化): `summary<level>_node_<id>`

## 4. 非機能要件

*   **使用技術**: TypeScript を主要言語として使用すること。
*   **実行環境**: Node.js 環境で動作し、Webサーバー (HTTP API) として機能を提供できること。
*   **永続化**: ログおよび要約データは永続化されること（具体的なDBの種類は未定だが、RDBまたはそれに準ずる構造を想定）。

## 5. 将来的な拡張（今回のスコープ外）

*   **粒度調整取得**: 指定された件数 `k` のログを取得する際に、最新のログほど詳細なレベル（レベル0に近い）で、古いログほど粗いレベル（レベルが高い）のノードを組み合わせて取得するアルゴリズムを実装する。
    *   例: 20件取得する場合、最新のログノード12件、レベル1要約ノード3件（=15件分の元ログ）、レベル2要約ノード1件（=25件分の元ログ）などを組み合わせる（組み合わせの最適化アルゴリズムが必要）。

## 6. 用語定義

*   **ログノード (Log Node)**: システムに追加される個々のログエントリ。レベル0のノード。
*   **要約ノード (Summary Node)**: 5つの下位ノード（ログノードまたは下位の要約ノード）をまとめたノード。レベル1以上のノード。
*   **レベル (Level)**: ノードの階層を示す数値。生ログはレベル0。レベル(N-1)のノード5つから生成された要約ノードはレベルN。